<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapDoc Pro - Offline-Ready OCR</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Cloudflare (cdnjs) for maximum reliability -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- OCR & DOCX Engines -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.5/tesseract.min.js"></script>
    <script src="https://unpkg.com/docx@8.2.3/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.321.0/umd/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .scroll-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function App() {
            const [logs, setLogs] = useState(["Application starting..."]);
            const [isReady, setIsReady] = useState(false);
            const [image, setImage] = useState(null);
            const [preview, setPreview] = useState(null);
            const [text, setText] = useState("");
            const [progress, setProgress] = useState(0);
            const [isWorking, setIsWorking] = useState(false);
            const [error, setError] = useState(null);
            
            const addLog = (msg) => setLogs(prev => [...prev.slice(-4), msg]);

            // Check for libraries with a more aggressive detector
            useEffect(() => {
                const timer = setInterval(() => {
                    const status = {
                        React: !!window.React,
                        Tesseract: !!window.Tesseract,
                        Docx: !!window.docx,
                        FileSaver: !!window.saveAs,
                        Lucide: !!window.lucide
                    };
                    
                    if (status.React && status.Tesseract && status.Docx && status.FileSaver) {
                        addLog("All engines online.");
                        setIsReady(true);
                        clearInterval(timer);
                    } else {
                        addLog(`Waiting for: ${Object.keys(status).filter(k => !status[k]).join(', ')}`);
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, []);

            const onFile = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setImage(file);
                    setPreview(URL.createObjectURL(file));
                    addLog("Image loaded: " + file.name);
                }
            };

            const runOCR = async () => {
                if (!image) return;
                setIsWorking(true);
                setError(null);
                addLog("Starting OCR engine...");
                
                try {
                    // Using the simplest v5 method for maximum compatibility
                    const result = await Tesseract.recognize(image, 'eng', {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                setProgress(Math.round(m.progress * 100));
                            }
                        }
                    });
                    setText(result.data.text);
                    addLog("Extraction complete.");
                } catch (err) {
                    console.error(err);
                    setError("OCR Failed. This usually means the Tesseract Worker script was blocked by your network.");
                    addLog("ERROR: OCR Failed.");
                } finally {
                    setIsWorking(false);
                }
            };

            const saveDoc = async () => {
                try {
                    const { Document, Packer, Paragraph, TextRun } = window.docx;
                    const doc = new Document({
                        sections: [{
                            children: text.split('\n').map(line => new Paragraph({
                                children: [new TextRun(line)]
                            }))
                        }]
                    });
                    const blob = await Packer.toBlob(doc);
                    window.saveAs(blob, "SnapDoc_Export.docx");
                    addLog("File exported successfully.");
                } catch (err) {
                    setError("Export failed.");
                }
            };

            if (!isReady) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-white flex-col p-6 text-center">
                        <div className="w-10 h-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <h1 className="text-xl font-bold">Connecting to Cloud Engines</h1>
                        <div className="mt-4 p-3 bg-slate-100 rounded text-[10px] font-mono w-full max-w-xs text-left overflow-hidden">
                            {logs.map((l, i) => <div key={i} className="whitespace-nowrap opacity-70 border-b border-slate-200 last:border-0 last:opacity-100">{`> ${l}`}</div>)}
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-4xl mx-auto p-4 md:p-10">
                    <header className="flex items-center justify-between mb-10">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 text-white p-2 rounded-xl shadow-lg shadow-indigo-200">
                                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            </div>
                            <h1 className="text-2xl font-bold tracking-tight">SnapDoc</h1>
                        </div>
                        <div className="text-[10px] font-bold text-slate-400 bg-slate-200 px-2 py-1 rounded">BROWSER OCR V5</div>
                    </header>

                    <div className="grid md:grid-cols-2 gap-8">
                        {/* INPUT SECTION */}
                        <div className="space-y-4">
                            <div 
                                onClick={() => document.getElementById('f').click()}
                                className="border-2 border-dashed border-slate-200 rounded-3xl p-8 bg-white hover:border-indigo-400 cursor-pointer transition-all h-[400px] flex flex-col items-center justify-center text-center overflow-hidden"
                            >
                                <input type="file" id="f" hidden onChange={onFile} accept="image/*" />
                                {preview ? (
                                    <img src={preview} className="h-full w-full object-contain" />
                                ) : (
                                    <>
                                        <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                                            <svg className="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        </div>
                                        <p className="font-bold text-slate-700">Click to upload photo</p>
                                        <p className="text-sm text-slate-400">Receipts, Reports, or Docs</p>
                                    </>
                                )}
                            </div>
                            
                            <button 
                                onClick={runOCR}
                                disabled={!image || isWorking}
                                className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-indigo-100 disabled:bg-slate-300 disabled:shadow-none transition-all active:scale-[0.98]"
                            >
                                {isWorking ? `Extracting Text... ${progress}%` : "Extract Text Now"}
                            </button>
                        </div>

                        {/* OUTPUT SECTION */}
                        <div className="flex flex-col gap-4">
                            <div className="bg-white rounded-3xl border border-slate-200 p-6 shadow-sm flex-grow h-[400px] flex flex-col">
                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Output Preview</h3>
                                <textarea 
                                    className="w-full flex-grow p-4 bg-slate-50 border-none rounded-2xl font-mono text-sm focus:ring-2 focus:ring-indigo-100 resize-none outline-none"
                                    value={text}
                                    onChange={(e) => setText(e.target.value)}
                                    placeholder="Your text will appear here..."
                                />
                            </div>

                            <button 
                                onClick={saveDoc}
                                disabled={!text || isWorking}
                                className="w-full bg-emerald-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-emerald-100 disabled:bg-slate-100 disabled:text-slate-300 disabled:shadow-none transition-all"
                            >
                                Download .docx File
                            </button>
                        </div>
                    </div>

                    {error && (
                        <div className="mt-8 p-4 bg-red-50 border border-red-100 rounded-2xl text-red-600 text-sm flex gap-3 items-center">
                            <div className="font-bold text-lg">!</div>
                            <p>{error}</p>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
